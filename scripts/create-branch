#!/bin/bash
# Create git branch following naming conventions
# Usage: create-branch [ticket-id] [description] [type]
# Types: feature, bug, defect, chore, hotfix, spike, debt

set -e

SCRIPT_DIR="$(dirname "$0")"
VALID_TYPES="feature bug defect chore hotfix spike debt"
BASE_BRANCHES="staging develop"

# Get employee code
emp_code=$("$SCRIPT_DIR/employee-code")

# Parse args
ticket=""
description=""
branch_type=""

case $# in
  3)
    ticket="$1"
    description="$2"
    branch_type="$3"
    ;;
  2)
    # Could be: ticket+desc, ticket+type, or desc+type
    if echo "$VALID_TYPES" | grep -qw "$2"; then
      # Second arg is type
      if [[ "$1" =~ ^[A-Z]+-[0-9]+$ ]]; then
        ticket="$1"
        branch_type="$2"
      else
        description="$1"
        branch_type="$2"
      fi
    else
      ticket="$1"
      description="$2"
    fi
    ;;
  1)
    if [[ "$1" =~ ^[A-Z]+-[0-9]+$ ]]; then
      ticket="$1"
    elif echo "$VALID_TYPES" | grep -qw "$1"; then
      branch_type="$1"
    else
      description="$1"
    fi
    ;;
esac

# Interactive prompts for missing info
if [[ -z "$description" ]]; then
  read -rp "Description (kebab-case): " description
fi

if [[ -z "$branch_type" ]]; then
  echo "Types: $VALID_TYPES"
  read -rp "Type: " branch_type
fi

# Validate type
if ! echo "$VALID_TYPES" | grep -qw "$branch_type"; then
  echo "Error: Invalid type '$branch_type'. Must be one of: $VALID_TYPES" >&2
  exit 1
fi

# Convert description to kebab-case
description=$(echo "$description" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')

# Determine base branch
current=$(git branch --show-current 2>/dev/null || echo "")
base_branch=""

for base in $BASE_BRANCHES; do
  if git show-ref --verify --quiet "refs/heads/$base" || \
     git show-ref --verify --quiet "refs/remotes/origin/$base"; then
    base_branch="$base"
    break
  fi
done

if [[ -z "$base_branch" ]]; then
  base_branch="main"
fi

# Build branch name
if [[ -n "$ticket" ]]; then
  branch_name="${emp_code}_${ticket}_${description}_${branch_type}"
else
  branch_name="${emp_code}_${description}_${branch_type}"
fi

# Create branch
git fetch origin
git checkout -b "$branch_name" "origin/$base_branch"

echo "Created branch: $branch_name"
